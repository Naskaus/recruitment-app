{% extends "base.html" %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <h1>Profile Form Configuration</h1>
        <p>Configure positions for {{ current_agency.name }}</p>
    </div>

    <div class="profile-config-container">
                 <!-- Agency Positions Configuration -->
         <div class="config-section">
             <div class="section-header">
                 <h3>Agency Positions</h3>
             </div>

            <div class="positions-list">
                <div class="position-item">
                    <div class="position-header">
                        <h4>{{ current_agency.name }} Positions</h4>
                        <button class="btn btn-sm btn-outline" onclick="editPositions()">Edit</button>
                    </div>
                    <div class="position-tags" id="positionsContainer">
                        {% for position in positions %}
                            <span class="tag" data-id="{{ position.id }}">{{ position.name }}</span>
                        {% else %}
                            <span class="no-positions">No positions defined yet</span>
                        {% endfor %}
                    </div>
                </div>
            </div>
                 </div>
    </div>
</div>

<!-- Position Edit Modal -->
<div class="modal-overlay hidden" id="positionModal">
    <div class="modal-content modal-md">
        <div class="modal-header">
            <h3 id="positionModalTitle">Edit Agency Positions</h3>
            <button class="modal-close-btn" id="closePositionModal">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Positions:</label>
                <div id="positionsList">
                    <!-- Position inputs will be loaded here -->
                </div>
                <button type="button" class="btn btn-sm btn-outline" id="addPositionInput">+ Add Position</button>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" id="cancelPositionEdit">Cancel</button>
            <button class="btn btn-primary" id="savePositions">Save Positions</button>
        </div>
    </div>
</div>

<script>
let positions = [];

function editPositions() {
    const modal = document.getElementById('positionModal');
    const title = document.getElementById('positionModalTitle');
    
    title.textContent = `Edit {{ current_agency.name }} Positions`;
    
    // Load current positions
    loadAgencyPositions();
    
    modal.classList.remove('hidden');
}

async function loadAgencyPositions() {
    try {
        const response = await fetch('/auth/api/positions');
        const data = await response.json();
        
        if (response.ok) {
            positions = data.positions;
            renderPositionInputs();
        } else {
            console.error('Failed to load positions:', data.message);
            alert('Failed to load positions: ' + data.message);
        }
    } catch (error) {
        console.error('Error loading positions:', error);
        alert('Error loading positions');
    }
}

function renderPositionInputs() {
    const positionsList = document.getElementById('positionsList');
    positionsList.innerHTML = '';
    
    positions.forEach(position => {
        addPositionInput(position.name, position.id);
    });
}

function addPositionInput(value = '', id = null) {
    const positionsList = document.getElementById('positionsList');
    const inputGroup = document.createElement('div');
    inputGroup.className = 'position-input-group';
    inputGroup.innerHTML = `
        <input type="text" class="form-control position-input" placeholder="Enter position name" value="${value}" data-id="${id || ''}">
        <button type="button" class="btn btn-sm btn-danger remove-position">Ã—</button>
    `;
    positionsList.appendChild(inputGroup);
}

async function savePositions() {
    console.log('savePositions function called');
    
    const positionInputs = document.querySelectorAll('.position-input');
    const newPositions = [];
    const updatedPositions = [];
    
    console.log('Found position inputs:', positionInputs.length);
    
    // Collect all positions
    positionInputs.forEach(input => {
        const name = input.value.trim();
        const id = input.dataset.id;
        
        console.log('Processing input:', { name, id });
        
        if (name) {
            if (id) {
                updatedPositions.push({ id: parseInt(id), name: name });
            } else {
                newPositions.push({ name: name });
            }
        }
    });
    
    console.log('New positions:', newPositions);
    console.log('Updated positions:', updatedPositions);
    
    try {
        console.log('Starting API calls...');
        
        // Create new positions
        for (const position of newPositions) {
            console.log('Creating position:', position);
            const response = await fetch('/auth/api/positions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
                },
                body: JSON.stringify(position)
            });
            
            console.log('Create response status:', response.status);
            
            if (!response.ok) {
                const data = await response.json();
                throw new Error(data.message || 'Failed to create position');
            }
        }
        
        // Update existing positions
        for (const position of updatedPositions) {
            const response = await fetch(`/auth/api/positions/${position.id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
                },
                body: JSON.stringify({ name: position.name })
            });
            
            if (!response.ok) {
                const data = await response.json();
                throw new Error(data.message || 'Failed to update position');
            }
        }
        
        // Close modal and reload
        document.getElementById('positionModal').classList.add('hidden');
        location.reload();
        
    } catch (error) {
        console.error('Error saving positions:', error);
        alert('Error saving positions: ' + error.message);
    }
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    const addPositionInputBtn = document.getElementById('addPositionInput');
    const closePositionModal = document.getElementById('closePositionModal');
    const cancelPositionEdit = document.getElementById('cancelPositionEdit');
    const savePositionsBtn = document.getElementById('savePositions');
    const positionModal = document.getElementById('positionModal');

    addPositionInputBtn.addEventListener('click', () => addPositionInput());
    
    closePositionModal.addEventListener('click', () => positionModal.classList.add('hidden'));
    cancelPositionEdit.addEventListener('click', () => positionModal.classList.add('hidden'));
    
    savePositionsBtn.addEventListener('click', savePositions);

    // Remove position input
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-position')) {
            e.target.closest('.position-input-group').remove();
        }
    });
});
</script>
{% endblock %}
