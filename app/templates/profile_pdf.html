<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Staff Profile - {{ profile.nickname }}</title>
    <style>
        @page { size: A4; margin: 1cm; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; color: #333; font-size: 9pt; line-height: 1.4; }
        .header { display: flex; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #1A2035; padding-bottom: 20px; }
        .header img { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; margin-right: 20px; border: 3px solid #E1E5EB; }
        .header .titles h1 { font-size: 24pt; margin: 0; color: #1A2035; }
        .header .titles h2 { font-size: 14pt; font-weight: normal; margin: 0; color: #4A90E2; }
        .header .agency-info { margin-left: auto; text-align: right; font-size: 8pt; color: #666; }
        .section { margin-bottom: 20px; break-inside: avoid; }
        .section h3 { font-size: 13pt; color: #1A2035; border-bottom: 1px solid #4A90E2; padding-bottom: 5px; margin: 0 0 10px 0; }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        .info-item { background-color: #f8f9fa; border: 1px solid #E1E5EB; border-radius: 4px; padding: 8px; }
        .info-item .label { font-size: 7pt; color: #7F8C99; text-transform: uppercase; }
        .info-item .value { font-size: 10pt; font-weight: 500; }
        .kpi-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        .kpi-card { background-color: #f8f9fa; border: 1px solid #E1E5EB; border-radius: 4px; padding: 8px; text-align: center; }
        .kpi-card .label { font-size: 7pt; color: #7F8C99; text-transform: uppercase; }
        .kpi-card .value { font-size: 12pt; font-weight: bold; }
        .profit-negative { color: #D9534F; }
        .profit-positive { color: #5CB85C; }
        .profit-negative-bg { background-color: #f8d7da; }
        .profit-positive-bg { background-color: #d4edda; }
        .assignments-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .assignments-table th, .assignments-table td { border-bottom: 1px solid #ddd; padding: 6px; text-align: left; }
        .assignments-table th { font-size: 8pt; background-color: #f8f9fa; }
    </style>
</head>
<body>
    <div class="header">
        {% if photo_url %}
            <img src="{{ photo_url }}" alt="Photo">
        {% endif %}
        <div class="titles">
            <h1>{{ profile.nickname }}</h1>
            <h2>{{ profile.status }}</h2>
        </div>
        <div class="agency-info">
            <strong>OS Agency</strong><br>
            Staff Performance Record<br>
            Generated: {{ report_date.strftime('%d %b %Y') }}
        </div>
    </div>

    <div class="section">
        <h3>Personal & Contact Information</h3>
        <div class="info-grid">
            <div class="info-item"><div class="label">Full Name</div><div class="value">{{ profile.first_name or 'N/A' }} {{ profile.last_name or 'N/A' }}</div></div>
            <div class="info-item"><div class="label">Age</div><div class="value">{{ profile.age or 'N/A' }}</div></div>
            <div class="info-item"><div class="label">Date of Birth</div><div class="value">{{ profile.dob.strftime('%d %b %Y') if profile.dob else 'N/A' }}</div></div>
            <div class="info-item"><div class="label">Phone</div><div class="value">{{ profile.phone or 'N/A' }}</div></div>
            <div class="info-item"><div class="label">Line ID</div><div class="value">{{ profile.line_id or 'N/A' }}</div></div>
            <div class="info-item"><div class="label">Instagram</div><div class="value">{{ profile.instagram or 'N/A' }}</div></div>
            <div class="info-item"><div class="label">Height</div><div class="value">{{ profile.height or 'N/A' }} cm</div></div>
            <div class="info-item"><div class="label">Weight</div><div class="value">{{ profile.weight or 'N/A' }} kg</div></div>
            <div class="info-item"><div class="label">Preferred Position</div><div class="value">{{ profile.preferred_position or 'N/A' }}</div></div>
        </div>
    </div>
    <div class="section">
        <h3>Performance History</h3>
        
        {% if filter_start_date or filter_end_date %}
        <div style="margin-bottom: 15px; font-size: 9pt; color: #666;">
            <strong>Filtres appliqués :</strong>
            {% if filter_start_date %}Du {{ filter_start_date.strftime('%d/%m/%Y') }}{% endif %}
            {% if filter_end_date %}au {{ filter_end_date.strftime('%d/%m/%Y') }}{% endif %}
        </div>
        {% endif %}
        
        <div class="kpi-grid">
            <div class="kpi-card"><div class="label">Total Days Worked</div><div class="value">{{ history_stats.total_days_worked }}</div></div>
            <div class="kpi-card"><div class="label">Total Drinks Sold</div><div class="value">{{ history_stats.total_drinks_sold }}</div></div>
            <div class="kpi-card"><div class="label">Total Salary Paid</div><div class="value">{{ '%.0f'|format(history_stats.total_salary_paid) }} ฿</div></div>
            <div class="kpi-card"><div class="label">Total Special Comm</div><div class="value">{{ '%.0f'|format(history_stats.total_special_comm) }} ฿</div></div>
            <div class="kpi-card"><div class="label">Total Commission Paid</div><div class="value">{{ '%.0f'|format(history_stats.total_commission_paid) }} ฿</div></div>
            <div class="kpi-card {% if history_stats.total_bar_profit > 0 %}profit-positive-bg{% elif history_stats.total_bar_profit < 0 %}profit-negative-bg{% endif %}">
                <div class="label">Total Bar Profit</div>
                <div class="value">{{ '%.0f'|format(history_stats.total_bar_profit) }} ฿</div>
            </div>
        </div>
        
        <h4 style="margin-top: 32px; margin-bottom: 16px;">Recent History</h4>
        <table class="assignments-table" style="width: 100%; margin-top: 10px;">
            <thead>
                <tr>
                    <th style="width: 15%;">Date</th>
                    <th style="width: 10%;">Dr</th>
                    <th style="width: 15%;">Sp.</th>
                    <th style="width: 15%;">Sal.</th>
                    <th style="width: 15%;">Com.</th>
                    <th style="width: 15%;">Profit</th>
                </tr>
            </thead>
            <tbody>
                {% if detailed_history %}
                    {% for record in detailed_history %}
                        <tr>
                            <td>{{ record.record_date.split('-')[2] }}/{{ record.record_date.split('-')[1] }}</td>
                            <td>{{ record.drinks_sold }}</td>
                            <td>{{ '%.0f'|format(record.special_commissions) }}฿</td>
                            <td>{{ '%.0f'|format(record.daily_salary) }}฿</td>
                            <td>{{ '%.0f'|format(record.daily_commission) }}฿</td>
                            <td {% if record.daily_profit > 0 %}class="profit-positive"{% elif record.daily_profit < 0 %}class="profit-negative"{% endif %}>
                                {{ '%.0f'|format(record.daily_profit) }}฿
                            </td>
                        </tr>
                    {% endfor %}
                {% else %}
                    <tr><td colspan="6" style="text-align: center;">No history yet.</td></tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <div class="section">
        <h3>Assignments History</h3>
        <table class="assignments-table">
            <thead>
                <tr>
                    <th>Period</th>
                    <th>Venue</th>
                    <th>Type</th>
                    <th>Status</th>
                    <th style="text-align: right;">Days</th>
                    <th style="text-align: right;">Drinks</th>
                    <th style="text-align: right;">Salary</th>
                    <th style="text-align: right;">Commission</th>
                    <th style="text-align: right;">Profit</th>
                </tr>
            </thead>
            <tbody>
                {% for item in assignments %}
                {% set a = item.assignment %}
                {% set stats = item.contract_stats %}
                <tr>
                    <td>{{ a.start_date.strftime('%d/%m/%y') }} - {{ a.end_date.strftime('%d/%m/%y') }}</td>
                    <td>{{ a.venue.name if a.venue else 'N/A' }}</td>
                    <td>{{ a.contract_type }}</td>
                    <td>{{ a.status }}</td>
                    <td style="text-align: right;">{{ stats.days_worked or 0 }}</td>
                    <td style="text-align: right;">{{ stats.drinks or 0 }}</td>
                    <td style="text-align: right;">{{ '%.0f'|format(stats.salary or 0) }} ฿</td>
                    <td style="text-align: right;">{{ '%.0f'|format(stats.commission or 0) }} ฿</td>
                    <td style="text-align: right;" class="{% if (stats.profit or 0) > 0 %}profit-positive{% elif (stats.profit or 0) < 0 %}profit-negative{% endif %}">
                        {{ '%.0f'|format(stats.profit or 0) }} ฿
                    </td>
                </tr>
                {% else %}
                <tr><td colspan="9" style="text-align: center;">No assignment history found.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</body>
</html>
