<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Payroll Report</title>
    <style>
        /* --- General Styles --- */
        @page { size: A4; margin: 1.5cm; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; font-size: 10pt; color: #333; line-height: 1.5; }
        .profit-negative { color: #D9534F !important; }
        .profit-positive { color: #5CB85C !important; }
        .footer { position: fixed; bottom: -1cm; left: 0; right: 0; text-align: center; font-size: 9pt; color: #888; border-top: 1px solid #ccc; padding-top: 5px; }

        /* --- Header Styles (Shared) --- */
        .header { display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 3px solid #1A2035; padding-bottom: 15px; margin-bottom: 20px; }
        .header .agency-title { font-size: 28pt; font-weight: bold; color: #1A2035; margin: 0; }
        .header .report-info { text-align: right; }
        .header .report-info h2 { font-size: 14pt; margin: 0; color: #1A2035; }
        .header .report-info p { font-size: 9pt; margin: 2px 0 0 0; color: #666; }

        /* --- INDIVIDUAL Report Styles --- */
        .staff-info h1 { font-size: 22pt; margin: 0 0 5px 0; color: #4A90E2; }
        .staff-info h3 { font-size: 14pt; font-weight: normal; margin: 0 0 25px 0; color: #555; }
        .grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px; }
        .info-box, .summary-box { border: 1px solid #E1E5EB; border-radius: 8px; padding: 15px; }
        .info-box h4, .summary-box h4, .daily-log-title { margin: 0 0 10px 0; font-size: 12pt; color: #1A2035; border-bottom: 1px solid #E1E5EB; padding-bottom: 8px; }
        .info-box p { margin: 4px 0; font-size: 10pt; }
        .info-box strong { display: inline-block; width: 100px; color: #555; }
        .summary-box table { width: 100%; }
        .summary-box td { padding: 5px 0; font-size: 10pt; }
        .summary-box td:last-child { text-align: right; font-weight: bold; }
        .details-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .details-table th, .details-table td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        .details-table th { background-color: #F8F9FB; font-weight: bold; }
        .details-table tbody tr:nth-child(even) { background-color: #f9f9f9; }

        /* --- GENERAL Report Styles --- */
        .filter-summary { background-color: #F8F9FB; border: 1px solid #E1E5EB; border-radius: 8px; padding: 10px 15px; margin-bottom: 25px; font-size: 9pt; }
        .kpi-summary { text-align: center; margin-bottom: 25px; font-size: 14pt; }
        .kpi-summary span { margin: 0 20px; }
        .kpi-summary strong { font-size: 18pt; color: #4A90E2; }
        .general-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .general-table th, .general-table td { border: 1px solid #ddd; padding: 8px; text-align: left; vertical-align: top; }
        .general-table th { background-color: #F8F9FB; font-weight: bold; font-size: 9pt; }
        .general-table .profit-cell { font-weight: bold; text-align: right; }
        .general-table .muted { color: #777; font-size: 8pt; }
    </style>
</head>
<body>

    {% if contract_stats is defined and contract_stats %}
    {# ================================================= #}
    {# =====      PART 1: INDIVIDUAL REPORT VIEW     ===== #}
    {# ================================================= #}
    {% set assignment = assignments[0].assignment %}
    {% set staff_name = assignment.staff.nickname if assignment.staff else assignment.archived_staff_name %}

    <div class="header">
        <h1 class="agency-title">OS Agency</h1>
        <div class="report-info">
            <h2>Final Contract Report</h2>
            <p>Generated on: {{ report_date.strftime('%B %d, %Y') }}</p>
        </div>
    </div>

    <div class="staff-info">
        <h1>{{ staff_name }}</h1>
        <h3>{{ assignment.role }}</h3>
    </div>

    <div class="grid-container">
        <div class="info-box">
            <h4>Contract Details</h4>
                            <p><strong>Staff ID:</strong> {{ assignment.staff.staff_id if assignment.staff else 'N/A' }}</p>
            <p><strong>Position:</strong> {{ assignment.contract_role }}</p>
            <p><strong>Venue:</strong> {{ assignment.venue.name }}</p>
            <p><strong>Period:</strong> {{ assignment.start_date.strftime('%d %b %Y') }} - {{ assignment.end_date.strftime('%d %b %Y') }}</p>
            <p><strong>Type:</strong> {{ '1-day' if assignment.contract_type == '1day' else '10-days' if assignment.contract_type == '10days' else '1-month' }}</p>
            <p><strong>Base Salary:</strong> {{ '{:,}'.format(assignment.base_salary) }} ฿</p>
            <p><strong>Manager:</strong> {{ assignment.manager.username if assignment.manager else 'N/A' }}</p>
        </div>
        <div class="summary-box">
            <h4>Performance Summary</h4>
            <table>
                                 <tr><td>Days Worked:</td><td>{{ assignments[0].days_worked }}</td></tr>
                 <tr><td>Drinks Sold:</td><td>{{ '{:,}'.format(contract_stats.drinks) }}</td></tr>
                 <tr><td>Special Comm:</td><td>{{ '{:,}'.format(contract_stats.special_comm) }} ฿</td></tr>
                 <tr><td>Commission Paid:</td><td>{{ '{:,}'.format(contract_stats.commission) }} ฿</td></tr>
                 <tr><td>Salary Paid:</td><td>{{ '{:,}'.format(contract_stats.salary) }} ฿</td></tr>
                 <tr><td><strong>Total Bar Profit:</strong></td><td class="{% if contract_stats.profit > 0 %}profit-positive{% elif contract_stats.profit < 0 %}profit-negative{% endif %}">{{ '{:,}'.format(contract_stats.profit) }} ฿</td></tr>
            </table>
        </div>
    </div>

    <h4 class="daily-log-title">Daily Performance Log</h4>
    <table class="details-table">
        <thead>
            <tr><th>Date</th><th>Arrival</th><th>Drinks</th><th>Bonus/Malus</th><th>Daily Salary</th><th>Daily Profit</th></tr>
        </thead>
        <tbody>
            {% for record in assignment.performance_records|sort(attribute='record_date') %}
                {% set base_daily = (assignment.base_salary / assignments[0].original_duration) if assignments[0].original_duration > 0 else 0 %}
                {% set penalty = record.lateness_penalty or 0 %}
                {% set daily_salary = base_daily + (record.bonus or 0) - (record.malus or 0) - penalty %}
                {% set daily_profit = ((record.drinks_sold or 0) * 120 + (record.special_commissions or 0)) - daily_salary %}
                <tr>
                                         <td>{{ record.record_date.strftime('%d %b %Y') }}</td>
                     <td>{{ record.arrival_time.strftime('%H:%M') if record.arrival_time else 'N/A' }}</td>
                     <td>{{ '{:,}'.format(record.drinks_sold or 0) }}</td>
                     <td>{{ '{:,}'.format((record.bonus or 0) - (record.malus or 0)) }} ฿</td>
                     <td>{{ '{:,}'.format(daily_salary) }} ฿</td>
                     <td class="{% if daily_profit > 0 %}profit-positive{% elif daily_profit < 0 %}profit-negative{% endif %}">{{ '{:,}'.format(daily_profit) }} ฿</td>
                </tr>
            {% else %}
                <tr><td colspan="6">No performance records found.</td></tr>
            {% endfor %}
        </tbody>
    </table>

    {% else %}
    {# ================================================= #}
    {# =====      PART 2: GENERAL REPORT VIEW      ===== #}
    {# ================================================= #}
    <div class="header">
        <h1 class="agency-title">OS Agency</h1>
        <div class="report-info">
            <h2>Payroll & Performance Report</h2>
            <p>Generated on: {{ report_date.strftime('%B %d, %Y') }}</p>
        </div>
    </div>

    <div class="filter-summary">
        <strong>Filters Applied:</strong>
        {% if filters.search_nickname %}<span>Name: <em>{{ filters.search_nickname }}</em> | </span>{% endif %}
        {% if filters.selected_venue %}<span>Venue: <em>{{ filters.selected_venue }}</em> | </span>{% endif %}
        {% if filters.selected_status %}<span>Status: <em>{{ filters.selected_status|capitalize }}</em> | </span>{% endif %}
        {% if filters.selected_manager_name %}<span>Manager: <em>{{ filters.selected_manager_name }}</em> | </span>{% endif %}
        {% if filters.selected_start_date or filters.selected_end_date %}
            <span>Period: <em>{{ filters.selected_start_date or 'Any' }} to {{ filters.selected_end_date or 'Any' }}</em></span>
        {% endif %}
    </div>
    
    <div class="kpi-summary">
        <span>Total Profit: <strong class="{% if summary.total_profit > 0 %}profit-positive{% elif summary.total_profit < 0 %}profit-negative{% endif %}">{{ '%.0f'|format(summary.total_profit) }} ฿</strong></span>
        <span>Total Days Worked: <strong>{{ summary.total_days_worked }}</strong></span>
    </div>

    <table class="general-table">
        <thead>
            <tr><th>Staff & Role</th><th>Venue</th><th>Contract</th><th>Period</th><th>Days Worked</th><th>Total Profit</th></tr>
        </thead>
        <tbody>
            {% for row in assignments %}
                {% set a = row.assignment %}
                <tr>
                    <td><strong>{{ a.staff.nickname if a.staff else a.archived_staff_name }}</strong><br><span class="muted">{{ a.role }}</span></td>
                    <td>{{ a.venue }}</td>
                    <td>{{ '1-day' if a.contract_type == '1day' else '10-days' if a.contract_type == '10days' else '1-month' }}<br><span class="muted">{{ '%.0f'|format(a.base_salary) }}฿</span></td>
                    <td>{{ a.start_date.strftime('%d/%m/%y') }} - {{ a.end_date.strftime('%d/%m/%y') }}</td>
                    <td style="text-align: center;">{{ row.days_worked }}</td>
                    <td class="profit-cell {% if row.contract_stats.profit > 0 %}profit-positive{% elif row.contract_stats.profit < 0 %}profit-negative{% endif %}">{{ '%.0f'|format(row.contract_stats.profit) }} ฿</td>
                </tr>
            {% else %}
                <tr><td colspan="6" style="text-align:center;">No contracts found for the selected filters.</td></tr>
            {% endfor %}
        </tbody>
    </table>
    {% endif %}

    <div class="footer">
        OS Agency | Confidential
    </div>
</body>
</html>
