{% extends "base.html" %}

{% block content %}
<style>
.contracts-container {
    max-width: 1200px;
    margin: 0 auto;
}

.contracts-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #e5e7eb;
}

.contracts-header h3 {
    margin: 0;
    color: #374151;
}

.contracts-list {
    display: grid;
    gap: 1.5rem;
}

.contract-item {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 1.5rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    transition: box-shadow 0.2s ease;
}

.contract-item:hover {
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.contract-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #f3f4f6;
}

.contract-header h4 {
    margin: 0;
    color: #1f2937;
    font-size: 1.25rem;
    font-weight: 600;
}

.contract-actions {
    display: flex;
    gap: 0.5rem;
}

.contract-details {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
}

.detail-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 0;
}

.detail-label {
    font-weight: 500;
    color: #6b7280;
    font-size: 0.875rem;
}

.detail-value {
    font-weight: 600;
    color: #1f2937;
}

.no-contracts {
    text-align: center;
    padding: 3rem;
    color: #6b7280;
    background: #f9fafb;
    border-radius: 8px;
    border: 2px dashed #d1d5db;
}

.form-grid-2 {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
}

@media (max-width: 768px) {
    .contracts-header {
        flex-direction: column;
        gap: 1rem;
        align-items: stretch;
    }
    
    .contract-header {
        flex-direction: column;
        gap: 1rem;
        align-items: stretch;
    }
    
    .contract-actions {
        justify-content: stretch;
    }
    
    .contract-details {
        grid-template-columns: 1fr;
    }
    
    .form-grid-2 {
        grid-template-columns: 1fr;
    }
}
</style>
<div class="card">
    <div class="card-header">
        <h2>Contract Configuration</h2>
        <p class="text-muted">Configure contracts for {{ current_agency.name }}</p>
    </div>
    <div class="card-body">
        <div class="contracts-container">
            <div class="contracts-header">
                <h3>Contract Types</h3>
                <button class="button button-primary" id="addContractBtn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    Add New Contract
                </button>
            </div>
            
            <div class="contracts-list" id="contractsList">
                {% for contract in contracts %}
                <div class="contract-item" data-id="{{ contract.id }}">
                    <div class="contract-header">
                        <h4>{{ contract.name }}</h4>
                        <div class="contract-actions">
                            <button class="button button-secondary edit-contract-btn" data-id="{{ contract.id }}">Edit</button>
                            {% if current_user.role in ['super_admin', 'webdev'] %}
                            <button class="button button-danger delete-contract-btn" data-id="{{ contract.id }}">Delete</button>
                            {% endif %}
                        </div>
                    </div>
                    <div class="contract-details">
                        <div class="detail-row">
                            <span class="detail-label">Duration:</span>
                            <span class="detail-value">{{ contract.days }} day{% if contract.days > 1 %}s{% endif %}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Late Cutoff:</span>
                            <span class="detail-value">{{ contract.late_cutoff_time }}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">First Minute Penalty:</span>
                            <span class="detail-value">{{ contract.first_minute_penalty }} THB</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Additional Minutes Penalty:</span>
                            <span class="detail-value">{{ contract.additional_minute_penalty }} THB/min</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Drink Price:</span>
                            <span class="detail-value">{{ contract.drink_price }} THB</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Staff Commission:</span>
                            <span class="detail-value">{{ contract.staff_commission }} THB</span>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="no-contracts">
                    <p>No contracts configured yet. Click "Add New Contract" to create your first contract type.</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Contract Modal -->
<div class="modal-overlay hidden" id="contractModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="contractModalTitle">Add New Contract</h3>
            <button class="modal-close-btn" id="closeContractModalBtn">&times;</button>
        </div>
        <div class="modal-body">
            <form id="contractForm">
                <input type="hidden" id="contractId" name="id">
                <div class="form-grid-2">
                    <div class="form-group">
                        <label for="contractName">Contract Name</label>
                        <input type="text" id="contractName" name="name" placeholder="e.g., 1 Day, 10 Days, 1 Month" required>
                    </div>
                    <div class="form-group">
                        <label for="contractDays">Duration (days)</label>
                        <input type="number" id="contractDays" name="days" min="1" max="31" placeholder="1-31" required>
                    </div>
                    <div class="form-group">
                        <label for="lateCutoffTime">Late Cutoff Time</label>
                        <input type="time" id="lateCutoffTime" name="late_cutoff_time" value="19:30" required>
                    </div>
                    <div class="form-group">
                        <label for="firstMinutePenalty">First Minute Penalty (THB)</label>
                        <input type="number" id="firstMinutePenalty" name="first_minute_penalty" min="0" step="0.01" value="0" required>
                    </div>
                    <div class="form-group">
                        <label for="additionalMinutePenalty">Additional Minutes Penalty (THB/min)</label>
                        <input type="number" id="additionalMinutePenalty" name="additional_minute_penalty" min="0" step="0.01" value="5" required>
                    </div>
                    <div class="form-group">
                        <label for="drinkPrice">Drink Price (THB)</label>
                        <input type="number" id="drinkPrice" name="drink_price" min="0" step="0.01" value="220" required>
                    </div>
                    <div class="form-group">
                        <label for="staffCommission">Staff Commission (THB)</label>
                        <input type="number" id="staffCommission" name="staff_commission" min="0" step="0.01" value="100" required>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="button button-secondary" id="cancelContractBtn">Cancel</button>
            <button type="submit" class="button button-primary" form="contractForm">Save Contract</button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const addContractBtn = document.getElementById('addContractBtn');
    const contractModal = document.getElementById('contractModal');
    const closeContractModalBtn = document.getElementById('closeContractModalBtn');
    const cancelContractBtn = document.getElementById('cancelContractBtn');
    const contractForm = document.getElementById('contractForm');
    const contractModalTitle = document.getElementById('contractModalTitle');
    const contractsList = document.getElementById('contractsList');

    let isEditMode = false;
    let currentContractId = null;

    // Open modal for adding new contract
    addContractBtn.addEventListener('click', () => {
        isEditMode = false;
        currentContractId = null;
        contractModalTitle.textContent = 'Add New Contract';
        contractForm.reset();
        document.getElementById('contractId').value = '';
        contractModal.classList.remove('hidden');
    });

    // Handle edit contract buttons
    contractsList.addEventListener('click', (e) => {
        if (e.target.classList.contains('edit-contract-btn')) {
            const contractId = e.target.dataset.id;
            editContract(contractId);
        } else if (e.target.classList.contains('delete-contract-btn')) {
            const contractId = e.target.dataset.id;
            deleteContract(contractId);
        }
    });

    // Close modal
    closeContractModalBtn.addEventListener('click', () => {
        contractModal.classList.add('hidden');
    });

    cancelContractBtn.addEventListener('click', () => {
        contractModal.classList.add('hidden');
    });

    // Close modal when clicking outside
    contractModal.addEventListener('click', (e) => {
        if (e.target === contractModal) {
            contractModal.classList.add('hidden');
        }
    });

    // Handle form submission
    contractForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const formData = new FormData(contractForm);
        const contractData = {
            name: formData.get('name'),
            days: parseInt(formData.get('days')),
            late_cutoff_time: formData.get('late_cutoff_time'),
            first_minute_penalty: parseFloat(formData.get('first_minute_penalty')),
            additional_minute_penalty: parseFloat(formData.get('additional_minute_penalty')),
            drink_price: parseFloat(formData.get('drink_price')),
            staff_commission: parseFloat(formData.get('staff_commission'))
        };

        if (isEditMode && currentContractId) {
            contractData.id = currentContractId;
        }

        try {
            const response = await fetch('/auth/api/contracts', {
                method: isEditMode ? 'PUT' : 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
                },
                body: JSON.stringify(contractData)
            });

            if (response.ok) {
                contractModal.classList.add('hidden');
                location.reload(); // Reload to show updated contracts
            } else {
                const data = await response.json();
                alert('Error: ' + (data.error || data.message));
            }
        } catch (error) {
            console.error('Error:', error);
            alert('An error occurred while saving the contract.');
        }
    });

    async function editContract(contractId) {
        try {
            const response = await fetch('/auth/api/contracts');
            if (!response.ok) throw new Error('Failed to load contracts');
            
            const data = await response.json();
            const contract = data.contracts.find(c => c.id == contractId);
            
            if (!contract) {
                alert('Contract not found');
                return;
            }

            isEditMode = true;
            currentContractId = contractId;
            contractModalTitle.textContent = 'Edit Contract';
            
            // Populate form
            document.getElementById('contractId').value = contract.id;
            document.getElementById('contractName').value = contract.name;
            document.getElementById('contractDays').value = contract.days;
            document.getElementById('lateCutoffTime').value = contract.late_cutoff_time;
            document.getElementById('firstMinutePenalty').value = contract.first_minute_penalty;
            document.getElementById('additionalMinutePenalty').value = contract.additional_minute_penalty;
            document.getElementById('drinkPrice').value = contract.drink_price;
            document.getElementById('staffCommission').value = contract.staff_commission;
            
            contractModal.classList.remove('hidden');
        } catch (error) {
            console.error('Error loading contract:', error);
            alert('Error loading contract details');
        }
    }

    async function deleteContract(contractId) {
        if (!confirm('Are you sure you want to delete this contract? This action cannot be undone.')) {
            return;
        }

        try {
            const response = await fetch(`/auth/api/contracts?id=${contractId}`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
                }
            });

            if (response.ok) {
                location.reload(); // Reload to show updated contracts
            } else {
                const data = await response.json();
                alert('Error: ' + (data.error || data.message));
            }
        } catch (error) {
            console.error('Error:', error);
            alert('An error occurred while deleting the contract.');
        }
    }
});
</script>
{% endblock %}

