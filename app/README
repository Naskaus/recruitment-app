# OS Agency â€” Master README (v0.9.9.4)
(Updated with Gemini 2.5 IDE Orchestration & Crash Recovery Context)

## 1. Overview / Purpose

OS Agency is a SaaS platform for talent agencies (recruitment, dispatch, payroll, performance).
The mission is to transform the current stable version into a robust, scalable, and market-ready SaaS (v1.0).

### Core Roles in Workflow

**Gemini (Strategist) â€” STRATEGO-V:** Defines vision, anticipates problems, produces sequential action plans, commands IDE in structured mini-prompts.

**IDE (Implementer) â€” Cursor or Windsurf:** Executes tasks, inspects files, runs tests, produces code. Operates in 3 modes (see below).

**Sebastien (Boss) â€”** Provides context, validates priorities, makes final decisions.

### IDE Modes (MANDATORY)

**Action Mode â†’** IDE executes Gemini's commands without analyzing or commenting, producing only the requested code/changes.

**Analyse Mode â†’** IDE inspects files, architecture, or history and delivers detailed factual information.

**Help Mode â†’** IDE provides explanations, documentation, or teaching assistance.

**Important Rule:** Gemini must always wait until full knowledge of repo & context is gathered before initiating Action Mode.

**Fallback:** If Gemini lacks confidence, it must query the IDE (Claude Sonnet 4 inside Cursor/Windsurf) before proceeding.

### Current Version: v0.9.9.4 (Post-crash recovery baseline)

**Immediate Goal:** ðŸ”§ **PRIORITÃ‰ NÂ°1 - Finaliser le Performance Dashboard** (dÃ©bogage + finitions CSS) + Complete bug-fixing sprint (#8, #9).

**Ultimate Goal (v1.0):** SaaS-ready, fast, secure, and scalable product.

## 2. Architecture & Tech Stack

ðŸ›  **Backend**
- Language: Python 3.9+
- Framework: Flask (Application Factory + Blueprints)
- ORM: SQLAlchemy + Flask-Migrate
- Services: Payroll (payroll_service.py, 612 lines), Agency Management
- PDF generation: WeasyPrint

ðŸŽ¨ **Frontend**
- Templates: Jinja2
- CSS: Custom + Tailwind (app/static/css/style.css, 106KB)
- JavaScript: Monolithic app.js (1201 lines â†’ refactoring planned)

ðŸ—„ **Database**
- Dev: SQLite
- Prod: Heroku PostgreSQL

ðŸš€ **Deployment**
- Web Server: PythonAnywhere
- Database: Heroku Postgres

ðŸ“‚ **Project Structure (Key Excerpts)**
Note on Cleanup: A "Grand Nettoyage" operation was performed. ~1.3 MB of unused/duplicate files (including a root static/ folder and old templates) have been moved to a _quarantine/ directory, pending final deletion. The canonical paths are now within the app/ directory.

## 3. Features

âœ… **Completed**
- Centralized calculations: payroll_service, ContractCalculations.
- RBAC stabilized: WEBDEV, SUPER_ADMIN, ADMIN, MANAGER.
- Contract lifecycle management.
- Multi-agency support with data isolation.
- Major Performance Overhaul: Resolved critical latency on the /payroll page, reducing load times from ~20s to < 2s.
- **NEW: Performance Dashboard** - Complete implementation (Phase A-C) with PDF export
- **NEW: Enhanced PDF Export** - Professional templates with optimized layout

## 4. Version History & Sprint Notes

### v0.9.9 -> v0.9.9.3 (Production Stability Marathon)
Post-Mortem: The initial v0.9.9 deployment failed in production, revealing extreme latency and UI bugs. A marathon debugging session identified a cascade of issues:
- Environment Mismatch: The core problem was a misconfigured PythonAnywhere environment (Working Directory, missing .env file, stubborn template cache).
- Solution: A "Phoenix Plan" was executed, involving a full deletion and recreation of the web app, a clean clone of the repository, and a meticulous reconfiguration.
- Performance Bug: The remaining latency was a business logic issue, loading all contracts by default.
- Final Fix: The /payroll route was refactored to default to filtering by status='active', solving the performance bottleneck.
- Code Cleanup: A "Grand Nettoyage" sprint was executed, quarantining all identified duplicate and orphaned files.

### v0.9.9.3 -> v0.9.9.4 (Crash Recovery & Dashboard Implementation)
- **Bug #8 (Payroll filters):** âœ… **RESOLVED** - Date format correction implemented
- **Bug #9 (Staff profile PDF):** ðŸ” **INVESTIGATED** - Root cause unclear, debugging traces added
- **Performance Dashboard:** ðŸ”§ **EN COURS DE DÃ‰BOGAGE ET FINITIONS CSS** - PrioritÃ© numÃ©ro 1
- **Debug Instrumentation:** Added traces in app/dispatch/routes.py for end_date calculation chain

### Bugs Pending (Current Sprint) ðŸŽ¯
- #6 Agency deletion button Not showing. Error when Delete.
- #7 Agency page translation (FR â†’ EN).
- #1 CSS desync (Staff List page). Status: âœ… COMPLETED
- #2 Incomplete user list (Admin missing, paused). Status: âœ… COMPLETED
- #8 Filtres and results not correct in Payroll (and in PDF as well): âœ… **RESOLVED**
- #9 In staff profile the filters works. But are not taken in the PDF: ðŸ” **INVESTIGATING**

## 5. Critical Missions

ðŸŽ¯ **Mission 1 â€” Payroll Latency**
- Status: âœ… COMPLETED
- Resolution: Solved via a strategic change in data loading. The /payroll page now defaults to filtering by status='active', reducing the initial dataset by >90%. Eager loading (joinedload) was also implemented to prevent N+1 queries.
- Success: Page loads are now < 2 seconds with the full production dataset.

ðŸŽ¯ **Mission 2 â€” app.js Refactor**
- Status: Pending. To be addressed after the current bug-fixing sprint.

ðŸŽ¯ **Mission 3 â€” Automated Testing**
- Status: Pending. pytest is installed and functional. Test coverage needs to be built.

ðŸŽ¯ **Mission 4 â€” UI Refactor**
- Status: Pending. Next major mission after bug fixes.

ðŸŽ¯ **Mission 5 â€” Performance Dashboard** ðŸ”§ **EN COURS - PRIORITÃ‰ NÂ°1**
- Status: ðŸ”§ **EN COURS DE DÃ‰BOGAGE ET FINITIONS CSS**
- Implementation: Dashboard fonctionnel mais nÃ©cessite dÃ©bogage et amÃ©liorations CSS
- Architecture: Isolated functionality with no impact on existing Payroll performance
- Security: Restricted access to SUPER_ADMIN and WEBDEV users
- **PRIORITÃ‰ IMMÃ‰DIATE:** Finaliser le dÃ©bogage et les finitions CSS

## 6. Deployment & DevOps

ðŸ”§ **Environment Variables**
.env file is mandatory on the server and must contain the production DATABASE_URL. It is NOT deployed via Git.

ðŸš¨ **Critical Deployment Lessons (v0.9.9.x)**
- Verify PA Web Tab Config: Always validate the 4 key paths: Source code, Working directory, Virtualenv, and WSGI file.
- Working Directory is CRITICAL: It must point to the project root (e.g., /home/Naskaus/recruitment-app), otherwise, Flask cannot find templates correctly.
- The "Phoenix Plan": In case of persistent "ghost" behavior, the ultimate solution is to delete and recreate the web app from the PythonAnywhere dashboard.

âœ… **WSGI Config (PythonAnywhere) - Validated**
```python
import os
import sys
from dotenv import load_dotenv

path = '/home/Naskaus/recruitment-app'
if path not in sys.path:
    sys.path.insert(0, path)

dotenv_path = os.path.join(path, '.env')
if os.path.exists(dotenv_path):
    load_dotenv(dotenv_path)

from app import create_app
application = create_app()
```

## 7. Prompt Archive & Notes

ðŸš€ **Strategic Orchestration Prompt (v0.9.8)**
- Defines roles: Gemini (Strategist), IDE (Implementer), Sebastien (Boss).
- Mandates discovery phase, sequential planning, validation loop.
- Output format: Markdown with mission, tasks, success criteria.

ðŸ“Œ **Add-on Context (v0.9.9)**
- 7 bugs listed with current statuses.
- Ongoing mission: export + delete orchestration (Agency management).

ðŸ“œ **Deployment Prompt**
- Role: Senior DevOps co-pilot.
- Language: Explanations in French, commands in native language.
- Guardrails: step-gating, secrets placeholders, verifications.
- Deliverables: Full deployment phases, WSGI config, backup automation, troubleshooting guide.

ðŸ†• **Crash Recovery Context (v0.9.9.4)**
- Bug #8 (Payroll filters): âœ… RESOLVED (date format correction).
- Bug #9 (Staff profile PDF): ðŸ” INVESTIGATED, root cause unclear.
- New Features: Performance Dashboard (Phase Aâ€“C complete), Optimized PDF export template, Robust performance metrics.
- Debugging: Added traces in app/dispatch/routes.py, followed end_date chain, confirmed no regression in Payroll.
- Security & Architecture: Complete isolation achieved, no side effects on Payroll, modularized features preserved.
- Summary: All documented in summary.md for future reference.

âœ… **Final Notes**
This README is both a technical documentation and a prompt scaffold.
It contains everything needed for Gemini â†” IDE orchestration, developer onboarding, debugging, deployment, and the long-term SaaS roadmap.

## 8. Communication Protocol (Gemini â†” IDE â†” Boss)

### At the start of every new chat:

**Gemini must query IDE with discovery commands** (repo structure, dependencies, database state, configs, logs).

**Gemini must not enter Action Mode until full context is validated.**

**Gemini uses IDE in strict mode selection** (Action / Analyse / Help).

**Sebastien validates priority sequence before any irreversible change.**

### IDE Mode Usage Rules:
- **Action Mode:** Execute commands without analysis or commentary
- **Analyse Mode:** Inspect and report factual information
- **Help Mode:** Provide explanations and documentation
- **Fallback:** If Gemini lacks confidence, query Claude Sonnet 4 inside IDE

## 9. Current State (v0.9.9.4)

### ðŸ“Š **STATUT ARCHITECTURAL**
L'application est stable et performante en production. L'architecture modulaire et SaaS-ready est validÃ©e et a survÃ©cu Ã  une sÃ©rie de tests de rÃ©sistance involontaires.

### âœ… **ProblÃ¨mes RÃ©solus RÃ©cemment**
- Performance / Latence : CorrigÃ©e (<2s).
- StabilitÃ© de DÃ©ploiement : Causes racines des Ã©checs identifiÃ©es et documentÃ©es.
- Nettoyage du Code : Fichiers inutiles mis en quarantaine.
- **Bug #8 (Payroll filters):** âœ… **RÃ‰SOLU** - Correction du format de date
- **Performance Dashboard:** âœ… **IMPLÃ‰MENTÃ‰** - FonctionnalitÃ© complÃ¨te avec export PDF

### ðŸ”„ **Prochaines Ã‰tapes RecommandÃ©es**

#### **ðŸ”§ Performance Dashboard - PRIORITÃ‰ NÂ°1**
- **Dashboard:** En cours de dÃ©bogage et finitions CSS
- **Objectif:** Finaliser l'interface et corriger les problÃ¨mes d'affichage
- **Statut:** Fonctionnel mais nÃ©cessite amÃ©liorations

#### **Sprint de Bugs Applicatifs (PrioritÃ© 2)**
- âœ… Bug #8 (Payroll filters): **RÃ‰SOLU**
- ðŸ” Bug #9 (Staff profile PDF): **EN INVESTIGATION** - Traces de dÃ©bogage ajoutÃ©es
- Corriger les bugs #6, #7 restants pour finaliser la stabilisation fonctionnelle.

#### **UI/UX Modernisation (PrioritÃ© 2)**
- Reprendre la migration vers Tailwind CSS et composants rÃ©utilisables.

#### **Refactor app.js (PrioritÃ© 3)**
- DÃ©composer le monolithe JavaScript.

#### **Automatisation (PrioritÃ© 4)**
- Mettre en place un pipeline CI/CD et une suite de tests complets.

### ðŸŽ¯ **ROADMAP V1.0**

La base technique Ã©tant maintenant Ã©prouvÃ©e et robuste, le focus se dÃ©place vers l'amÃ©lioration fonctionnelle et l'expÃ©rience utilisateur pour atteindre la v1.0.

### ðŸ†• **Nouvelles FonctionnalitÃ©s ImplÃ©mentÃ©es (v0.9.9.4)**
- **Performance Dashboard:** ðŸ”§ **EN COURS DE DÃ‰BOGAGE ET FINITIONS CSS** - PrioritÃ© NÂ°1
- **Export PDF OptimisÃ©:** Templates professionnels avec mise en page avancÃ©e
- **SystÃ¨me de Calculs Robuste:** MÃ©triques basÃ©es sur ContractCalculations avec fallback
- **Architecture Modulaire:** Isolation complÃ¨te des nouvelles fonctionnalitÃ©s

### ðŸ”§ **AmÃ©liorations Techniques AppliquÃ©es**
- **StratÃ©gie de Non-RÃ©gression:** Aucun impact sur les performances existantes
- **SÃ©curitÃ© RenforcÃ©e:** ContrÃ´le d'accÃ¨s appropriÃ© pour les nouvelles fonctionnalitÃ©s
- **Code Maintenable:** Architecture modulaire et bien structurÃ©e

---

## ðŸ† **CONCLUSION**

Cette session a Ã©tÃ© trÃ¨s productive avec la rÃ©solution complÃ¨te du bug des filtres Payroll et l'implÃ©mentation du Performance Dashboard. **PRIORITÃ‰ ACTUELLE NÂ°1 : Finaliser le dÃ©bogage et les finitions CSS du Dashboard.** L'approche mÃ©thodique de dÃ©bogage et la stratÃ©gie de non-rÃ©gression ont permis d'avancer efficacement sans compromettre la stabilitÃ© de l'application existante.

**Statut Global :** ðŸŸ¢ **EXCELLENT** - Objectifs principaux atteints avec succÃ¨s

### **Key Improvements in v0.9.9.4**
- Added IDE modes (Action / Analyse / Help) with strict usage protocol.
- Integrated "wait for full knowledge before action" rule.
- Added fallback to Claude Sonnet 4 if Gemini unsure.
- Merged in Crash Recovery report (summary.md) with bug statuses & new features.
- Updated version marker â†’ v0.9.9.4.

### **Techniques Applied**
- Constraint optimization (strict IDE mode rules)
- Chain-of-thought orchestration (discovery â†’ validation â†’ action)
- Memory continuity (merging summary.md context into README)

---

## ðŸ—ï¸ **ARCHITECTURE ACTUELLE DE L'APPLICATION**

### **Structure des Dossiers Principaux**
```
recruitment-app/
â”œâ”€â”€ .git/                          # ContrÃ´le de version
â”œâ”€â”€ app/                           # Application principale Flask
â”‚   â”œâ”€â”€ __init__.py               # Configuration Flask + Application Factory
â”‚   â”œâ”€â”€ models.py                 # ModÃ¨les SQLAlchemy (Assignment, StaffProfile, etc.)
â”‚   â”œâ”€â”€ decorators.py             # DÃ©corateurs d'authentification et autorisation
â”‚   â”œâ”€â”€ admin/                    # Routes d'administration (gestion agences)
â”‚   â”œâ”€â”€ auth/                     # Authentification et gestion utilisateurs
â”‚   â”œâ”€â”€ dispatch/                 # Gestion des contrats et assignments
â”‚   â”œâ”€â”€ main/                     # Routes principales et navigation
â”‚   â”œâ”€â”€ payroll/                  # SystÃ¨me de paie et calculs
â”‚   â”œâ”€â”€ pilot/                    # FonctionnalitÃ©s pilotes et expÃ©rimentales
â”‚   â”œâ”€â”€ services/                 # Services mÃ©tier (payroll_service.py)
â”‚   â”œâ”€â”€ staff/                    # Gestion du personnel et profils
â”‚   â”œâ”€â”€ static/                   # Assets statiques (CSS, JS, images)
â”‚   â””â”€â”€ templates/                # Templates Jinja2 HTML
â”œâ”€â”€ data/                         # Base de donnÃ©es locale SQLite
â”œâ”€â”€ logs/                         # Fichiers de log de l'application
â”œâ”€â”€ migrations/                   # Migrations Alembic pour la base de donnÃ©es
â”œâ”€â”€ tests/                        # Tests automatisÃ©s pytest
â”œâ”€â”€ uploads/                      # Fichiers uploadÃ©s par les utilisateurs
â”œâ”€â”€ archive/                      # Archives du projet et anciennes versions
â”œâ”€â”€ scripts/                      # Scripts utilitaires et maintenance
â”œâ”€â”€ config.py                     # Configuration de l'application
â”œâ”€â”€ requirements.txt              # DÃ©pendances Python
â”œâ”€â”€ app.py                        # Point d'entrÃ©e principal (48KB, 1130 lignes)
â”œâ”€â”€ run.py                        # Script de dÃ©marrage Flask
â””â”€â”€ .flaskenv                     # Variables d'environnement Flask
```

### **Architecture Backend**

#### **Framework et ORM**
- **Flask** : Application Factory avec Blueprints modulaires
- **SQLAlchemy** : ORM avec Flask-Migrate pour les migrations
- **Structure Blueprint** : Chaque module (payroll, dispatch, admin) est isolÃ©

#### **ModÃ¨les de DonnÃ©es ClÃ©s**
- **Assignment** : Contrats et missions du personnel
- **StaffProfile** : Profils du personnel avec isolation par agence
- **AgencyContract** : Types de contrats et durÃ©es
- **PerformanceRecord** : Historique des performances
- **ContractCalculations** : Calculs prÃ©-calculÃ©s pour la performance

#### **Services MÃ©tier**
- **payroll_service.py** (612 lignes) : Logique mÃ©tier pour la paie
- **agency_management_service.py** : Gestion des agences
- **SystÃ¨me de calculs** : AgrÃ©gation intelligente avec fallback manuel

### **Architecture Frontend**

#### **Templates et Rendu**
- **Jinja2** : Moteur de templates avec hÃ©ritage
- **Base Template** : `base.html` avec navigation et structure commune
- **Templates Modulaires** : Chaque blueprint a ses propres templates

#### **Assets et Styling**
- **CSS Principal** : `app/static/css/style.css` (106KB)
- **Tailwind CSS** : Migration en cours vers composants modernes
- **JavaScript** : `app/static/js/app.js` (1201 lignes - monolithe Ã  refactorer)

#### **Interface Utilisateur**
- **Responsive Design** : Bootstrap + Tailwind pour l'adaptabilitÃ©
- **Navigation** : Menu principal avec contrÃ´le d'accÃ¨s par rÃ´le
- **Formulaires** : Validation cÃ´tÃ© client et serveur

### **SystÃ¨me d'Authentification et Autorisation**

#### **RÃ´les Utilisateurs**
- **WEBDEV** : AccÃ¨s complet Ã  toutes les agences
- **SUPER_ADMIN** : Administration complÃ¨te de l'agence
- **ADMIN** : Gestion des utilisateurs et paramÃ¨tres
- **MANAGER** : Gestion des contrats et du personnel
- **USER** : AccÃ¨s limitÃ© aux fonctionnalitÃ©s de base

#### **DÃ©corateurs de SÃ©curitÃ©**
- **@login_required** : Authentification obligatoire
- **@super_admin_required** : AccÃ¨s restreint aux administrateurs
- **@dispatch_view_required** : Lecture seule sur les dispatchs
- **@dispatch_edit_required** : Modification des dispatchs

### **Gestion des DonnÃ©es**

#### **Isolation Multi-Agences**
- **Principe** : Chaque utilisateur ne voit que les donnÃ©es de son agence
- **ImplÃ©mentation** : Filtrage automatique par `agency_id` dans toutes les requÃªtes
- **SÃ©curitÃ©** : Validation des permissions au niveau des routes

#### **Base de DonnÃ©es**
- **DÃ©veloppement** : SQLite (`data/recruitment-dev.db`)
- **Production** : Heroku PostgreSQL
- **Migrations** : Alembic pour la gestion des schÃ©mas

### **Performance et Optimisation**

#### **Optimisations Actuelles**
- **Filtrage par dÃ©faut** : `/payroll` charge uniquement les contrats 'active'
- **Eager Loading** : `joinedload` pour Ã©viter les requÃªtes N+1
- **Cache des calculs** : `ContractCalculations` pour les mÃ©triques frÃ©quentes

#### **Monitoring et Logs**
- **Logs d'application** : `logs/os_agency.log`
- **Gestion des erreurs** : Try-catch avec logging appropriÃ©
- **Performance** : Temps de chargement < 2s sur la page Payroll

### **DÃ©ploiement et Infrastructure**

#### **Environnements**
- **DÃ©veloppement** : Local avec SQLite
- **Production** : PythonAnywhere + Heroku PostgreSQL
- **Configuration** : Variables d'environnement via `.env`

#### **SÃ©curitÃ© de Production**
- **Variables sensibles** : Non commitÃ©es dans Git
- **HTTPS** : ForcÃ© en production
- **Validation des donnÃ©es** : CÃ´tÃ© serveur obligatoire

### **Ã‰tat Actuel de l'Architecture**

#### **âœ… Points Forts**
- **ModularitÃ©** : Blueprints bien sÃ©parÃ©s et maintenables
- **SÃ©curitÃ©** : RBAC robuste avec isolation des donnÃ©es
- **Performance** : Optimisations critiques implÃ©mentÃ©es
- **ScalabilitÃ©** : Structure prÃªte pour la croissance

#### **ðŸ”§ AmÃ©liorations en Cours**
- **Performance Dashboard** : En cours de dÃ©bogage et finitions CSS (PrioritÃ© NÂ°1)
- **Refactoring JavaScript** : DÃ©composition du monolithe app.js
- **Migration Tailwind** : Modernisation de l'interface utilisateur

#### **ðŸ“‹ Roadmap Architecture**
- **Phase 1** : Finaliser le Performance Dashboard
- **Phase 2** : Refactor app.js en modules
- **Phase 3** : Migration complÃ¨te vers Tailwind CSS
- **Phase 4** : Tests automatisÃ©s et CI/CD
